ITEM.name = "Cigarette"
ITEM.description = "A classic tobacco-filled cigarette."
ITEM.model = "models/phycinnew.mdl"
ITEM.width = 1
ITEM.height = 1
ITEM.outfitCategory = "smokable"
ITEM.pacData = {
	[1] = {
		["children"] = {
			[1] = {
				["children"] = {
					[1] = {
						["children"] = {
							[1] = {
								["children"] = {},
								["self"] = {
									["Velocity"] = -2.2999999523163,
									["UniqueID"] = "298233769",
									["StickStartSize"] = 20,
									["EndLength"] = 0,
									["PositionSpread2"] = Vector(0, 0, 0),
									["EndSize"] = 1.3999999761581,
									["RollDelta"] = 0,
									["OwnerName"] = "self",
									["AimPartName"] = "",
									["StartSize"] = 0.40000000596046,
									["NoTextureFiltering"] = false,
									["IgnoreZ"] = false,
									["Gravity"] = Vector(0, 0, 100),
									["StickEndSize"] = 0,
									["StickLifetime"] = 0.20000000298023,
									["ParticleAngleVelocity"] = Vector(50, 50, 50),
									["AimPartUID"] = "",
									["Additive"] = false,
									["PositionSpread"] = 0,
									["RandomColor"] = false,
									["RandomRollSpeed"] = 0,
									["StickStartAlpha"] = 255,
									["Angles"] = Angle(74.642211914063, -179.99981689453, -179.99961853027),
									["StartLength"] = 0,
									["Spread"] = 0.60000002384186,
									["IsDisturbing"] = false,
									["OwnerVelocityMultiplier"] = 0,
									["Translucent"] = false,
									["FireDelay"] = 0,
									["ParticleAngle"] = Angle(0, 0, 0),
									["Follow"] = false,
									["Lighting"] = false,
									["StickToSurface"] = true,
									["Color1"] = Vector(134, 109, 110),
									["Bounce"] = 5,
									["DrawOrder"] = 0,
									["Collide"] = true,
									["Name"] = "slime1",
									["Material"] = "atmos/rainsmoke",
									["3D"] = false,
									["NumberParticles"] = 1,
									["EndAlpha"] = 0,
									["Bone"] = "head",
									["StartAlpha"] = 18.10000038147,
									["AirResistance"] = 9.1999998092651,
									["AddFrametimeLife"] = false,
									["Sliding"] = true,
									["Position"] = Vector(0.865234375, -0.03515625, -0.31515502929688),
									["Color2"] = Vector(255, 255, 255),
									["BlendMode"] = "",
									["Hide"] = false,
									["AlignToSurface"] = true,
									["ClassName"] = "particles",
									["EyeAngles"] = false,
									["EditorExpand"] = false,
									["DoubleSided"] = false,
									["PositionOffset"] = Vector(0, 0, 0),
									["AngleOffset"] = Angle(0, 0, 0),
									["StickEndAlpha"] = 0,
									["DieTime"] = 0.40000000596046,
									["DrawManual"] = false
								}
							}
						},
						["self"] = {
							["DrawOrder"] = 0,
							["UniqueID"] = "1432910589",
							["OwnerName"] = "self",
							["AimPartName"] = "",
							["Bone"] = "head",
							["Position"] = Vector(2.7599999904633, 0, 0),
							["AimPartUID"] = "",
							["Hide"] = false,
							["Name"] = "",
							["AngleOffset"] = Angle(0, 0, 0),
							["EditorExpand"] = true,
							["EyeAngles"] = false,
							["PositionOffset"] = Vector(0, 0, 0),
							["IsDisturbing"] = false,
							["ClassName"] = "clip",
							["Translucent"] = false,
							["Angles"] = Angle(0, 180, -180)
						}
					},
					[2] = {
						["children"] = {},
						["self"] = {
							["Skin"] = 0,
							["Invert"] = false,
							["LightBlend"] = 1,
							["CellShade"] = 0,
							["OwnerName"] = "self",
							["AimPartName"] = "",
							["IgnoreZ"] = false,
							["AimPartUID"] = "",
							["Passes"] = 1,
							["Name"] = "",
							["NoTextureFiltering"] = false,
							["DoubleFace"] = false,
							["PositionOffset"] = Vector(0.78799998760223, 0, -0.0049999998882413),
							["IsDisturbing"] = false,
							["Fullbright"] = false,
							["EyeAngles"] = false,
							["DrawOrder"] = 0,
							["TintColor"] = Vector(0, 0, 0),
							["UniqueID"] = "237817144",
							["Translucent"] = false,
							["LodOverride"] = -1,
							["BlurSpacing"] = 0,
							["Alpha"] = 1,
							["Material"] = "models/effects/splode_sheet",
							["UseWeaponColor"] = false,
							["UsePlayerColor"] = false,
							["UseLegacyScale"] = false,
							["Bone"] = "head",
							["Color"] = Vector(228, 83, 21),
							["Brightness"] = 32,
							["BoneMerge"] = false,
							["BlurLength"] = 0,
							["Position"] = Vector(0.943, -0.002, 0.008),
							["AngleOffset"] = Angle(0, 0, 0),
							["AlternativeScaling"] = false,
							["Hide"] = false,
							["OwnerEntity"] = false,
							["Scale"] = Vector(0.5, 1, 1),
							["ClassName"] = "model",
							["EditorExpand"] = false,
							["Size"] = 0.026,
							["ModelFallback"] = "",
							["Angles"] = Angle(0, 0, 0),
							["TextureFilter"] = 3,
							["Model"] = "models/hunter/misc/sphere025x025.mdl",
							["BlendMode"] = ""
						}
					}
				},
				["self"] = {
					["Skin"] = 0,
					["Invert"] = false,
					["LightBlend"] = 1,
					["CellShade"] = 0,
					["OwnerName"] = "self",
					["AimPartName"] = "",
					["IgnoreZ"] = false,
					["AimPartUID"] = "",
					["Passes"] = 1,
					["Name"] = "",
					["NoTextureFiltering"] = false,
					["DoubleFace"] = false,
					["PositionOffset"] = Vector(0, 0, 0),
					["IsDisturbing"] = false,
					["Fullbright"] = false,
					["EyeAngles"] = false,
					["DrawOrder"] = 0,
					["TintColor"] = Vector(0, 0, 0),
					["UniqueID"] = "2609739004",
					["Translucent"] = false,
					["LodOverride"] = -1,
					["BlurSpacing"] = 0,
					["Alpha"] = 1,
					["Material"] = "",
					["UseWeaponColor"] = false,
					["UsePlayerColor"] = false,
					["UseLegacyScale"] = false,
					["Bone"] = "mouth",
					["Color"] = Vector(255, 255, 255),
					["Brightness"] = 1,
					["BoneMerge"] = false,
					["BlurLength"] = 0,
					["Position"] = Vector(1.14794921875, -1.14453125, -0.02227783203125),
					["AngleOffset"] = Angle(0, 0, 0),
					["AlternativeScaling"] = false,
					["Hide"] = false,
					["OwnerEntity"] = false,
					["Scale"] = Vector(1, 1, 1),
					["ClassName"] = "model",
					["EditorExpand"] = true,
					["Size"] = 0.80000001192093,
					["ModelFallback"] = "",
					["Angles"] = Angle(-1.4087265299167e-05, -14.146657943726, 1.7075473124351e-06),
					["TextureFilter"] = 3,
					["Model"] = "models/phycinnew.mdl",
					["BlendMode"] = ""
				}
			}
		},
		["self"] = {
			["DrawOrder"] = 0,
			["UniqueID"] = "2275412082",
			["AimPartUID"] = "",
			["Hide"] = false,
			["Duplicate"] = false,
			["ClassName"] = "group",
			["OwnerName"] = "self",
			["IsDisturbing"] = false,
			["Name"] = "cig",
			["EditorExpand"] = true
		}
	}
}

ITEM.hooks.Equip = function(item, data)
	item.player:SetNetVar("cigTimeLeft", item:GetData("timeLeft", 1))
end

function ITEM:PaintOver(item, w, h)
    local timeLeft = item:GetData("timeLeft", 1)
	local equipped = item:GetData("equip", false)

    if timeLeft != nil then
        surface.SetDrawColor(equipped and HSVToColor((.25 * 360) * timeLeft, 1, 1) or Color(118,118,118))
        surface.DrawRect(2, h - 4, (w - 4) * timeLeft, 2)
    end

	if (equipped) then
		surface.SetDrawColor(110, 255, 110, 100)
		surface.DrawRect(w - 14, h - 14, 8, 8)
	end
end

if SERVER then
	timer.Create("cigTimer", 1, 0, function()
		for _, ply in ipairs(player.GetAll()) do
			-- this should have all been wrapped in the player loop
			-- you're using ply here which doesn't exist unless you're in the loop
			local character = ply:GetCharacter()
			if not character then continue end
			local inventory = character:GetInventory()
			local items = inventory:GetItems()

			for _, item in pairs(items) do
				if item.uniqueID ~= "cigarette"
				and item.uniqueID ~= "uu_cigarette" then continue end

				local smokeTime = item.uniqueID == "cigarette" and SMOKE_TIME or SMOKE_TIME_BLUE

				local equipped = item:GetData("equip", false)
				local timeLeft = item:GetData("timeLeft", 1)

				if equipped == true then
					local smokeTime = 60 * 16
					if item.uniqueID == "uu_cigarette" then
						smokeTime = smokeTime / 2
					end
                    local adjusted = timeLeft - (1 / smokeTime)
					item:SetData("timeLeft", adjusted)
					ply:SetNetVar("cigTimeLeft", adjusted)

					if timeLeft <= 0 then
						item:Remove()
						ply:SetNetVar("cigTimeLeft", 1)
						ply:EmitSound("npc/barnacle/neck_snap1.wav", 70, 100, 0.35)
					end
				end
			end
		end
	end)
end

if CLIENT then
	hook.Add("Think", "cigPACAdjust", function()
		--[[for _, v in pairs(player.GetAll()) do
			local ply = v

			--if !IsValid(ply) or !ply.pac_outfits then return end

			for _, outfit in pairs(PAC_ALL_PARTS) do
				if not outfit:IsValid() then continue end
				--print(outfit.Name, ply, outfit.Owner)

				if outfit.Name:find("cig") and IsValid(outfit.Owner) then
					local group = outfit:GetChildren()[1]
					if not group then continue end

					if group.Owner != ply then continue end

				-- 0.16 - 2.76
				local cigTimeLeft = outfit.Owner:GetNetVar("cigTimeLeft", 1)
				clip.Position.x = math.Remap(cigTimeLeft, 0, 1, 0.16, 2.76)
				ember.PositionOffset.x = 0.788 - (2.76 - clip.Position.x)
			end
		end]]
	end)
end